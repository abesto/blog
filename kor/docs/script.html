 <!DOCTYPE html>  <html> <head>   <title>script.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               script.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This script shows an example for integrating the Raphael and Knockout libraries.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Graph</span><span class="p">,</span> <span class="nx">View</span><span class="p">,</span> <span class="nx">helpers</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Event handlers for GUI actions</h2>

<p>Set up handlers for events fired via the eve library
bundled with Raphael.js, returning a function that sets the current action</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">initActions</span><span class="p">()</span> 
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">currentAction</span> <span class="o">=</span> <span class="s1">&#39;noop&#39;</span><span class="p">,</span> <span class="nx">actions</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>First level: selected action<br>
Second level: event name after <code>graph.</code> prefix</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">actions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;create-node&#39;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s1">&#39;paper-clicked&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">createNode</span><span class="p">();</span> <span class="p">}</span>
            <span class="p">},</span>

            <span class="s1">&#39;delete-node&#39;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s1">&#39;node-clicked&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">deleteNode</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span> <span class="p">}</span>
            <span class="p">},</span>

            <span class="s1">&#39;create-edge&#39;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s1">&#39;node-dnd-node&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span> <span class="p">}</span>
            <span class="p">},</span>

            <span class="s1">&#39;delete-edge&#39;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s1">&#39;edge-clicked&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">edge</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">deleteEdge</span><span class="p">(</span><span class="nx">edge</span><span class="p">);</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Bind to all graph events, call appropriate handler if exists</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">eve</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;graph.*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Controller received event &quot;</span> <span class="o">+</span> <span class="nx">eve</span><span class="p">.</span><span class="nx">nt</span><span class="p">(),</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">eve</span><span class="p">.</span><span class="nx">nt</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">actions</span><span class="p">[</span><span class="nx">currentAction</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span>
                <span class="k">typeof</span><span class="p">(</span><span class="nx">actions</span><span class="p">[</span><span class="nx">currentAction</span><span class="p">][</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">actions</span><span class="p">[</span><span class="nx">currentAction</span><span class="p">][</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The function to set the action</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> 
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Action set to &quot;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">);</span>
            <span class="nx">currentAction</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span> 
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Graph model</h2>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Graph</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">Node</span><span class="p">,</span> <span class="nx">Edge</span><span class="p">,</span> <span class="nx">Constructor</span><span class="p">,</span> <span class="nx">gid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">eid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">nid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><strong>Simple node model</strong>. Note that label and color are observables,
while the edges will be observable on the graph model.
You'll probably want to have a list of in-edges and out-edges in
real uses.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Node</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">Node</span><span class="p">(</span><span class="nx">graph</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;node&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">label</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observable</span><span class="p">(</span><span class="s1">&#39;N&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">nid</span><span class="o">++</span><span class="p">));</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observable</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">);</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><strong>Simple edge model</strong>. Note again that label and color are observables.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Edge</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">Edge</span><span class="p">(</span><span class="nx">graph</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;edge&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">label</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observable</span><span class="p">(</span><span class="s1">&#39;E&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">eid</span><span class="o">++</span><span class="p">));</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observable</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><strong>Graph model</strong>. This is a bit more complex.</p>

<p>The node and edge lists are <code>observableArray</code> objects.
<code>createNode</code>, <code>deleteNode</code>, <code>connect</code> and <code>deleteEdge</code> operate on them.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Constructor</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">Graph</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">Graph</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">gid</span><span class="o">++</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">nodes</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observableArray</span><span class="p">();</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">edges</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observableArray</span><span class="p">();</span>
            <span class="p">};</span>

            <span class="nx">Graph</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createNode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">nodes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="nx">Graph</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deleteNode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">edges</span><span class="p">,</span> <span class="nx">edge</span><span class="p">;</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">nodes</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
                <span class="nx">edges</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">edges</span><span class="p">();</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">edges</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">edge</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">unwrapObservable</span><span class="p">(</span><span class="nx">edges</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">edge</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">edge</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="nx">node</span> <span class="o">||</span> <span class="nx">edge</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">deleteEdge</span><span class="p">(</span><span class="nx">edge</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">};</span>

            <span class="nx">Graph</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">edge</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Edge</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">edges</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">edge</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">edge</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="nx">Graph</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deleteEdge</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">edge</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">edge</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">edges</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">edge</span><span class="p">);</span>
            <span class="p">};</span>

            <span class="k">return</span> <span class="nx">Graph</span><span class="p">;</span>
        <span class="p">})();</span>

        <span class="k">return</span> <span class="nx">Constructor</span><span class="p">;</span>
    <span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Custom Knockout binding handlers</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>element.attr</h3>

<p>Create a Knockout binding handler calling the Raphael <code>.attr</code> method.</p>

<p><code>paper</code> is a required parameter because handlers must be bound to DOM
objets, and there's no way to get the Raphael paper object from an
SVG or VML object.</p>

<p>The handler returned by this function accepts a hash as argument.
The <code>.attr</code> method will be called with the key-value pairs specified
in the hash for the updated object.</p>

<p>Values can be KO observables (this is the point of the whole thing)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">createRaphaelAttrBindingHandler</span><span class="p">(</span><span class="nx">paper</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">valueAccessor</span><span class="p">,</span> <span class="nx">allBindingsAccessor</span><span class="p">,</span> <span class="nx">viewModel</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">dict</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">unwrapObservable</span><span class="p">(</span><span class="nx">valueAccessor</span><span class="p">()),</span> <span class="nx">key</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">dict</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">paper</span><span class="p">.</span><span class="nx">getById</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">raphaelid</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">unwrapObservable</span><span class="p">(</span><span class="nx">dict</span><span class="p">[</span><span class="nx">key</span><span class="p">]));</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>Nodes</h3>

<p>Creates a KO binding to handle node creation/removal</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">createNodesBindingHandler</span><span class="p">(</span><span class="nx">paper</span><span class="p">)</span>
    <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Store a list of node views</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">paper</span><span class="p">.</span><span class="nx">nodes</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Create the representation of a recently created node model</p>

<p>Position is specified by the lastClick property of the paper,
which is the last click event received by the paper (saved by us).</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">createView</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">circle</span><span class="p">,</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">st</span><span class="p">;</span>
            <span class="nx">x</span> <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">lastClick</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">layerX</span><span class="p">;</span>
            <span class="nx">y</span> <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">lastClick</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">layerY</span><span class="p">;</span>
            </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Create the Raphael objects</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">circle</span> <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">circle</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="mi">20</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">);</span>
            <span class="nx">label</span> <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">label</span><span class="p">());</span>
            <span class="nx">st</span> <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">set</span><span class="p">().</span><span class="nx">push</span><span class="p">(</span><span class="nx">circle</span><span class="p">,</span> <span class="nx">label</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Set the model on every object, so it's easy to get it in event handlers</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">circle</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
            <span class="nx">label</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
            <span class="nx">st</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">circle</span> <span class="o">=</span> <span class="nx">circle</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Add the view to our list</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">paper</span><span class="p">.</span><span class="nx">nodes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">st</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>This is where we set up the KO bindings.
<code>color</code> and <code>label</code> are observables of the Node model. <code>p1_r_attr</code> is the
handler returned by the above <code>createRaphaelAttrBindingHandler</code> function,
hard-coded here for simplicity.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">$</span><span class="p">(</span><span class="nx">circle</span><span class="p">.</span><span class="nx">node</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-bind&#39;</span><span class="p">,</span> <span class="s1">&#39;p1_r_attr: { stroke: color }&#39;</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">label</span><span class="p">.</span><span class="nx">node</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-bind&#39;</span><span class="p">,</span> <span class="s1">&#39;p1_r_attr: { fill: color, text: label }&#39;</span><span class="p">);</span>
            <span class="nx">ko</span><span class="p">.</span><span class="nx">applyBindings</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">circle</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
            <span class="nx">ko</span><span class="p">.</span><span class="nx">applyBindings</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">label</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
            </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Fire node-clicked event and prevent the click from reaching the paper</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">st</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">eve</span><span class="p">(</span><span class="s1">&#39;graph.node-clicked&#39;</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">graph</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span> 
                <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span> 
            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Currently the only case of dragging we care about is when
a node is dropped on another node</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">st</span><span class="p">.</span><span class="nx">drag</span><span class="p">(</span>
                    <span class="kc">null</span><span class="p">,</span>  <span class="c1">// onmove</span>
                    <span class="kc">null</span><span class="p">,</span>  <span class="c1">// onstart</span>
                    <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span> 
                        <span class="kd">var</span> <span class="nx">fromModel</span> <span class="o">=</span> <span class="nx">node</span><span class="p">,</span>
                            <span class="nx">ontoView</span> <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">getElementByPoint</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Is there an element where user stopped dragging?</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="nx">ontoView</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>If so, fire an appropriate event
The event name will be graph.node-dnd-node or graph-node-dnd-edge
The event handler will be called with the graph as context,
arguments will be the nodes we're connecting</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="kd">var</span> <span class="nx">ontoModel</span> <span class="o">=</span> <span class="nx">ontoView</span><span class="p">.</span><span class="nx">model</span><span class="p">;</span>
                            <span class="nx">eve</span><span class="p">(</span><span class="s1">&#39;graph.node-dnd-&#39;</span> <span class="o">+</span> <span class="nx">ontoModel</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">fromModel</span><span class="p">.</span><span class="nx">graph</span><span class="p">,</span> <span class="nx">fromModel</span><span class="p">,</span> <span class="nx">ontoModel</span><span class="p">);</span> 
                        <span class="p">}</span>
                    <span class="p">}</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>This is the actual method that will be called by KO</p>

<p>The relation between the number of nodes in the graph model and the views list
declared above tells us what has happened:</p>

<p>Requirements:
 - Only one element is added / removed at a time
 - Adding only happens at the end of the node array (push)
 - The graph property of a removed Node model is set to null <em>before</em> being removed</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">valueAccessor</span><span class="p">,</span> <span class="nx">allBindingsAccessor</span><span class="p">,</span> <span class="nx">viewModel</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span>
                    <span class="nx">models</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">unwrapObservable</span><span class="p">(</span><span class="nx">valueAccessor</span><span class="p">()),</span>
                    <span class="nx">views</span>  <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">nodes</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>The relation between the number of nodes in the graph model and the views list
declared above tells us what has happened:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Nothing interesting</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">views</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>A new node has been created</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">views</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">createView</span><span class="p">(</span><span class="nx">models</span><span class="p">[</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>A node has been removed. Which one?
We required that the graph property of removed nodes be set to null.
This is where we use that, to find out which node to remove.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">views</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">views</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">views</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">model</span><span class="p">.</span><span class="nx">graph</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">views</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">remove</span><span class="p">();</span>
                            <span class="nx">views</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>                   
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>This should never happen.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">throw</span> <span class="s2">&quot;Mayday!&quot;</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h3>Edges</h3>

<p>Completely analogous to <code>createNodeBindingHandler</code> above</p>

<p>It's probably possible to refactor some these two functions, they share
a lot of code</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">createEdgesBindingHandler</span><span class="p">(</span><span class="nx">paper</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">paper</span><span class="p">.</span><span class="nx">edges</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="kd">function</span> <span class="nx">createView</span><span class="p">(</span><span class="nx">edge</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">st</span><span class="p">;</span>
            <span class="nx">x</span> <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">lastClick</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">layerX</span><span class="p">;</span>
            <span class="nx">y</span> <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">lastClick</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">layerY</span><span class="p">;</span>
            
            <span class="nb">window</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">edge</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>

            <span class="nx">path</span> <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">&#39;M&#39;</span> <span class="o">+</span> <span class="nx">edge</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nx">edge</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cy&#39;</span><span class="p">)</span> <span class="o">+</span>
                              <span class="s1">&#39;L&#39;</span> <span class="o">+</span> <span class="nx">edge</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nx">edge</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cy&#39;</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="nx">label</span> <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span>
                    <span class="p">(</span><span class="nx">edge</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">edge</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> 
                    <span class="p">(</span><span class="nx">edge</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cy&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">edge</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cy&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="nx">edge</span><span class="p">.</span><span class="nx">label</span><span class="p">()</span>
            <span class="p">);</span>
            <span class="nx">st</span> <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">set</span><span class="p">();</span>
            <span class="nx">st</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">label</span><span class="p">);</span>

            <span class="nx">label</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">edge</span><span class="p">;</span>
            <span class="nx">path</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">edge</span><span class="p">;</span>
            <span class="nx">st</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">edge</span><span class="p">;</span>

            <span class="nx">edge</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span><span class="p">;</span>
            <span class="nx">paper</span><span class="p">.</span><span class="nx">edges</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">st</span><span class="p">);</span>

            <span class="nx">$</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-bind&#39;</span><span class="p">,</span> <span class="s1">&#39;p1_r_attr: { stroke: color }&#39;</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">label</span><span class="p">.</span><span class="nx">node</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-bind&#39;</span><span class="p">,</span> <span class="s1">&#39;p1_r_attr: { fill: color, text: label }&#39;</span><span class="p">);</span>
            
            <span class="nx">st</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span> 
                <span class="nx">eve</span><span class="p">(</span><span class="s1">&#39;graph.edge-clicked&#39;</span><span class="p">,</span> <span class="nx">edge</span><span class="p">.</span><span class="nx">graph</span><span class="p">,</span> <span class="nx">edge</span><span class="p">);</span> 
                <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span> 
            <span class="p">});</span>

            <span class="nx">ko</span><span class="p">.</span><span class="nx">applyBindings</span><span class="p">(</span><span class="nx">edge</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
            <span class="nx">ko</span><span class="p">.</span><span class="nx">applyBindings</span><span class="p">(</span><span class="nx">edge</span><span class="p">,</span> <span class="nx">label</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">valueAccessor</span><span class="p">,</span> <span class="nx">allBindingsAccessor</span><span class="p">,</span> <span class="nx">viewModel</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span>
                    <span class="nx">models</span> <span class="o">=</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">unwrapObservable</span><span class="p">(</span><span class="nx">valueAccessor</span><span class="p">()),</span>
                    <span class="nx">views</span>  <span class="o">=</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">edges</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">views</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">views</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">createView</span><span class="p">(</span><span class="nx">models</span><span class="p">[</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">views</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">views</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">views</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">model</span><span class="p">.</span><span class="nx">graph</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">views</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">remove</span><span class="p">();</span>
                            <span class="nx">views</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>                   
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="s2">&quot;Mayday!&quot;</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Finally we set up the main interface</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">paper</span><span class="p">,</span> <span class="nx">setAction</span><span class="p">;</span>

        <span class="nx">g</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Graph</span><span class="p">();</span>
        <span class="nx">paper</span> <span class="o">=</span> <span class="nx">Raphael</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">);</span>

        <span class="nx">ko</span><span class="p">.</span><span class="nx">bindingHandlers</span><span class="p">.</span><span class="nx">nodes</span> <span class="o">=</span> <span class="nx">createNodesBindingHandler</span><span class="p">(</span><span class="nx">paper</span><span class="p">);</span>
        <span class="nx">ko</span><span class="p">.</span><span class="nx">bindingHandlers</span><span class="p">.</span><span class="nx">edges</span> <span class="o">=</span> <span class="nx">createEdgesBindingHandler</span><span class="p">(</span><span class="nx">paper</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;graph&#39;</span><span class="p">,</span> <span class="nx">g</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-bind&#39;</span><span class="p">,</span> <span class="s1">&#39;nodes: nodes, edges: edges&#39;</span><span class="p">);</span>
        <span class="nx">ko</span><span class="p">.</span><span class="nx">bindingHandlers</span><span class="p">.</span><span class="nx">p1_r_attr</span> <span class="o">=</span> <span class="nx">createRaphaelAttrBindingHandler</span><span class="p">(</span><span class="nx">paper</span><span class="p">);</span>
        
        <span class="nx">ko</span><span class="p">.</span><span class="nx">applyBindings</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>

        <span class="nx">setAction</span> <span class="o">=</span> <span class="nx">initActions</span><span class="p">(</span><span class="nx">paper</span><span class="p">,</span> <span class="nx">g</span><span class="p">);</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#controls input&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
            <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">setAction</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span> <span class="p">});</span>
        <span class="p">});</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">paper</span><span class="p">.</span><span class="nx">lastClick</span> <span class="o">=</span> <span class="nx">event</span><span class="p">;</span>
            <span class="nx">eve</span><span class="p">(</span><span class="s1">&#39;graph.paper-clicked&#39;</span><span class="p">,</span> <span class="nx">g</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">})();</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html>  